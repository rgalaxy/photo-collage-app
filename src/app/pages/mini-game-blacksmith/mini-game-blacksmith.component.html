<div class="blacksmith-game">
  <!-- Toast Container -->
  <div class="toast-container">
    @for (toast of toasts; track toast) {
      <div
        class="toast"
        [class.success]="toast.success"
        [class.error]="!toast.success"
        >
        <div class="toast-message">{{ toast.message }}</div>
        <button class="toast-close" (click)="removeToast(toast.id)">√ó</button>
      </div>
    }
  </div>

  <!-- High Scores Toggle (Fixed position) -->
  <div class="high-scores-toggle">
    <button class="toggle-btn" (click)="toggleHighScores()">
      {{ showHighScores ? "‚ùå" : "üèÜ" }}
    </button>
  </div>

  <!-- High Scores Panel (Sliding from right) -->
  <div class="high-scores-panel" [class.show]="showHighScores">
    <h3>üèÜ Top Blacksmiths</h3>
    <div class="high-score-list">
      @for (score of highScores; track score; let i = $index) {
        <div
          class="high-score-item"
          >
          <div class="rank-badge">{{ i + 1 }}</div>
          <div class="score-details">
            <div class="player-name">{{ score.screen_name }}</div>
            <div class="score-value">{{ score.score }}</div>
            @if (score.item_name) {
              <div class="item-name">
                {{ score.item_name }}
              </div>
            }
          </div>
        </div>
      }
      @if (highScores.length === 0) {
        <div class="no-scores">
          No high scores yet. Be the first!
        </div>
      }
    </div>
  </div>

  <!-- Main Game Content -->
  <div class="main-content">
    <!-- Game Header (Compact) -->
    <div class="game-header">
      <h1 class="game-title">Yanto's Blacksmith v1.1</h1>
      @if (gameActive) {
        <div class="game-stats">
          <div class="stat">
            <span class="stat-label">Score:</span>
            <span class="stat-value">{{ score }}</span>
          </div>
          <div class="stat">
            <span class="stat-label">Time:</span>
            <span class="stat-value">{{ timeRemaining }}s</span>
          </div>
          <button
            class="finish-btn"
            (click)="finishForging()"
            [disabled]="gameOver"
            >
            ‚úÖ Finish
          </button>
        </div>
      }
    </div>

    <!-- Game Setup (when not playing) -->
    @if (!gameActive) {
      <div class="game-setup">
        <div class="setup-panel">
          <h2>Ready to Forge?</h2>
          <div class="input-group">
            <input
              id="playerName"
              type="text"
              [(ngModel)]="playerName"
              placeholder="Enter your name"
              maxlength="20"
              autocomplete="off"
              />
          </div>
          <div class="setup-buttons">
            <button class="start-btn" (click)="startGame()">
              Start Forging! ‚öíÔ∏è
            </button>
            <button class="how-to-play-btn" (click)="openHowToPlayModal()">
              How To Play
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Game Interface (when playing) -->
    @if (gameActive) {
      <div class="game-interface">
        <!-- Weapon Selection (Compact) -->
        @if (!currentWeapon) {
          <div class="weapon-selection">
            <h3>üó°Ô∏è Select Weapon</h3>
            <div class="weapon-grid">
              @for (weapon of weapons; track weapon) {
                <button
                  class="weapon-btn"
                  (click)="selectedWeaponId = weapon.id; selectWeapon()"
                  >
                  {{ weapon.name }} ({{ weapon.baseScore }})
                </button>
              }
            </div>
          </div>
        }
        <!-- Forging Interface (Compact) -->
        @if (currentWeapon) {
          <div class="forging-interface">
            <!-- Current Weapon Display (Compact) -->
            <div class="current-weapon">
              <div class="weapon-display">
                <h3 class="weapon-name">
                  {{
                  getWeaponDisplayName() ||
                  "basic " + currentWeapon.weapon.name.toLowerCase()
                  }}
                </h3>
                <div class="weapon-stats">
                  <span class="stat-compact"
                    >+{{ currentWeapon.refinement }}/15</span
                    >
                    <span class="stat-compact">{{ currentWeapon.quality }}</span>
                    <span class="stat-compact"
                      >{{ currentWeapon.elements.length }}/4 elements</span
                      >
                    </div>
                  </div>
                </div>
                <!-- Forging Actions (Compact Grid) -->
                <div class="forging-actions">
                  <!-- Refine Action -->
                  <div class="action-card">
                    <h4>‚ö° Refine</h4>
                    <p class="success-rate">{{ getRefinementSuccessRate() }}%</p>
                    @if (currentWeapon.refinement <= 8 && !isRefinementOnCooldown()) {
                      <p
                        class="warning"
                        >
                        üõ°Ô∏è Safe zone (1-8)!
                      </p>
                    }
                    @if (currentWeapon.refinement <= 8 && isRefinementOnCooldown()) {
                      <p
                        class="cooldown"
                        >
                        Cooldown: {{ getCeilRefinementCooldown() }}s
                      </p>
                    }
                    @if (currentWeapon.refinement >= 9) {
                      <p class="warning">
                        üíÄ Danger zone!
                      </p>
                    }
                    <button
                      class="action-btn refine-btn"
                      [disabled]="!canRefine()"
                      (click)="refineWeapon()"
                      >
                      Hit
                    </button>
                  </div>
                  <!-- Quality Action -->
                  <div class="action-card">
                    <h4>‚ú® Quality</h4>
                    @if (canImproveQuality() && !isQualityOnCooldown()) {
                      <p
                        class="success-rate"
                        >
                        {{ getQualitySuccessRate() }}%
                      </p>
                    }
                    @if (isQualityOnCooldown()) {
                      <p class="cooldown">
                        Cooldown: {{ getCeilQualityCooldown() }}s
                      </p>
                    }
                    <button
                      class="action-btn quality-btn"
                      [disabled]="!canImproveQuality() || isQualityOnCooldown()"
                      (click)="improveQuality()"
                      >
                      Improve
                    </button>
                  </div>
                  <!-- Element Action -->
                  <div class="action-card">
                    <h4>üåü Element</h4>
                    @if (currentWeapon.refinement < 5) {
                      <p class="requirement">
                        Need +5
                      </p>
                    }
                    @if (currentWeapon.refinement >= 5) {
                      <div
                        class="element-selection"
                        >
                        <select [(ngModel)]="selectedElement" class="element-dropdown">
                          <option value="">Select</option>
                          @for (element of getAvailableElements(); track element) {
                            <option
                              [value]="element"
                              >
                              {{ element | titlecase }}
                            </option>
                          }
                        </select>
                        @if (selectedElement && !isElementOnCooldown(selectedElement)) {
                          <p
                            class="success-rate"
                            >
                            {{ getElementSuccessRate() }}%
                          </p>
                        }
                        @if (selectedElement && isElementOnCooldown(selectedElement)) {
                          <p
                            class="cooldown"
                            >
                            Cooldown: {{ getCeilElementCooldown(selectedElement) }}s
                          </p>
                        }
                        <button
                          class="action-btn element-btn"
                [disabled]="
                  !canAddElement() ||
                  (selectedElement && isElementOnCooldown(selectedElement))
                "
                          (click)="addElement()"
                          >
                          Add
                        </button>
                      </div>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>

      <!-- Finish Confirmation Modal -->
      @if (showFinishConfirmation) {
        <div
          class="modal-overlay"
          (click)="cancelFinishForging()"
          >
          <div class="modal-content" (click)="$event.stopPropagation()">
            <h3>Finish Forging?</h3>
            <p>Are you sure you want to finish forging and submit your score?</p>
            <p>
              <strong>Current Score: {{ score }}</strong>
            </p>
            @if (currentWeapon) {
              <p>
                <strong>Item: {{ getWeaponDisplayName() }}</strong>
              </p>
            }
            <div class="modal-buttons">
              <button class="modal-btn cancel-btn" (click)="cancelFinishForging()">
                Cancel
              </button>
              <button class="modal-btn confirm-btn" (click)="confirmFinishForging()">
                Finish
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Game Over Modal -->
      @if (showGameOverModal) {
        <div class="game-over-modal">
          <div class="game-over-content">
            <h2>üéØ Game Over!</h2>
            <div class="game-over-reason">{{ gameOverReason }}</div>
            <div class="final-score">
              <div class="score-label">Final Score</div>
              <div class="score-value">{{ score }}</div>
            </div>
            @if (currentWeapon) {
              <div class="final-item">
                Final Item: {{ getWeaponDisplayName() }}
              </div>
            }
            <div class="game-over-actions">
              <button class="game-over-btn new-game-btn" (click)="startNewGame()">
                üîÑ New Game
              </button>
              <button class="game-over-btn close-btn" (click)="closeGameOverModal()">
                üìã View Scores
              </button>
            </div>
          </div>
        </div>
      }

      <!-- How To Play Modal -->
      @if (showHowToPlayModal) {
        <div class="modal-overlay">
          <div class="modal-content how-to-play-modal">
            <h3>‚öíÔ∏è How To Play</h3>
            <div class="how-to-play-content">
              <ul>
                <li><strong>Choose a weapon</strong> to start forging</li>
                <li>
                  <strong>Refine (+)</strong> to increase weapon level (higher risk at
                  higher levels)
                </li>
                <li>
                  <strong>Safe Zone (1-8):</strong> Weapons cannot break during
                  refinements +1 to +8, but failed attempts trigger a 3-second
                  cooldown
                </li>
                <li>
                  <strong>Danger Zone (9+):</strong> At +9 and above, weapons can
                  break and end the game immediately
                </li>
                <li>
                  <strong>Improve Quality</strong> to boost weapon grade (cooldown:
                  30s)
                </li>
                <li>
                  <strong>Add Element</strong> for bonus points (cooldown: 10s per
                  element)
                </li>
                <li>
                  <strong>Finish early</strong> to secure your score, or let time run
                  out
                </li>
                <li>
                  You have <strong>60 seconds</strong> to forge the best weapon!
                </li>
                <li>
                  <strong>Note:</strong> Only 75% of your score is submitted to
                  leaderboard when your weapon breaks during refinement
                </li>
              </ul>
            </div>
            <div class="modal-buttons">
              <button class="modal-btn confirm-btn" (click)="closeHowToPlayModal()">
                Got it!
              </button>
            </div>
          </div>
        </div>
      }
    </div>
